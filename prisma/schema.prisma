// Prisma schema for Gorean RP Server
// Manages users, stats, and events for Second Life integration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String      @id @default(uuid())
  slUuid       String      @map("sl_uuid") // Second Life UUID
  universe     String      @default("Gor") @map("universe") // Universe identifier (e.g., "Gor", "Fantasy", etc.)
  username     String
  role         Role        @default(FREE)
  title        String?     @db.VarChar(512) // Optional RP title (max 512 chars)
  titleColor   String      @default("<1, 1, 1>") @map("title_color") // LSL color vector
  knownRecipes String[]    @default([]) @map("known_recipes") // Array of recipe shortNames
  groups       Json?       @default("{}") @map("groups") // Social groups: {"Allies": [arkanaStats.id], "Enemies": [arkanaStats.id]}
  createdAt    DateTime    @default(now()) @map("created_at")
  lastActive   DateTime    @default(now()) @map("last_active")

  // Relations
  stats        UserStats?
  events       Event[]
  inventories  UserInventory[]
  profileTokens ProfileToken[]
  rentingEstates Estate[]    @relation("EstateRenter")
  tenantEstates Estate[]    @relation("EstateTenants")
  arkanaStats  ArkanaStats?
  goreanStats  GoreanStats?
  npcTasks     NPCTask[]
  craftings    Crafting[]

  @@unique([slUuid, universe]) // Composite unique constraint
  @@map("users")
}

model UserStats {
  id          Int      @id @default(autoincrement())
  userId      String   @unique @map("user_id")
  status      Int      @default(0)
  health      Int      @default(100)
  hunger      Int      @default(100)
  thirst      Int      @default(100)
  goldCoin    Int      @default(0) @map("gold_coin")
  silverCoin  Int      @default(0) @map("silver_coin")
  copperCoin  Int      @default(10) @map("copper_coin")
  lastUpdated DateTime @default(now()) @map("last_updated")
  
  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_stats")
}

model Event {
  id        String   @id @default(uuid())
  type      String
  details   Json
  timestamp DateTime @default(now())
  userId    String   @map("user_id")
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("events")
}

// RP Items registry
model RpItem {
  id                      Int              @id @default(autoincrement())
  name                    String
  shortName               String           @map("short_name")
  universe                String           @default("Gor")  // Universe this item belongs to
  isShortNameDifferent    Boolean          @default(false) @map("is_short_name_different")
  category                String
  tags                    String           @default("")
  hungerValue             Int              @default(0) @map("hunger_value")
  thirstValue             Int              @default(0) @map("thirst_value")
  healthValue             Int              @default(0) @map("health_value")
  edible                  Boolean          @default(false)
  drinkable               Boolean          @default(false)
  useCount                Int              @default(0) @map("use_count")
  priceGold               Int              @default(0) @map("price_gold")
  priceSilver             Int              @default(0) @map("price_silver")
  priceCopper             Int              @default(0) @map("price_copper")

  // Relations
  userInventory           UserInventory[]

  @@unique([shortName, universe])  // Composite unique constraint
  @@map("rp_items")
}

// Player inventory items (per user, per rp item)
model UserInventory {
  id          Int     @id @default(autoincrement())
  userId      String  @map("user_id")
  rpItemId    Int     @map("rpitem_id")
  quantity    Int     @default(0)
  useCount    Int     @default(0) @map("use_count")
  priceGold   Int     @default(0) @map("price_gold")
  priceSilver Int     @default(0) @map("price_silver")
  priceCopper Int     @default(0) @map("price_copper")

  // Relations
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  item        RpItem  @relation(fields: [rpItemId], references: [id], onDelete: Cascade)

  @@unique([userId, rpItemId])
  @@map("user_inventory")
}

// Profile tokens for secure web access
model ProfileToken {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  token       String   @unique
  expiresAt   DateTime @map("expires_at")
  sessionId   String?  @map("session_id")  // Session ID for browser session tracking
  createdAt   DateTime @default(now()) @map("created_at")
  
  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([expiresAt])
  @@index([userId])
  @@map("profile_tokens")
}

// Estate rental system
model Estate {
  id              Int       @id @default(autoincrement())
  estateId        String    @map("estate_id")  // Estate identifier from LSL
  universe        String    @default("Gor")     // Universe this estate belongs to
  name            String
  description     String?
  rentPricePerDay Int       @map("rent_price_per_day")  // Price per day in copper coins
  rentingUserId   String?   @map("renting_user_id")     // Current renter (optional)
  location        String?   // Location metadata/description
  rentStartDate   DateTime? @map("rent_start_date")     // When current rental started
  rentEndDate     DateTime? @map("rent_end_date")       // When current rental ends
  totalPaidAmount Int       @default(0) @map("total_paid_amount") // Total copper paid for current rental
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  rentingUser     User?     @relation("EstateRenter", fields: [rentingUserId], references: [id], onDelete: SetNull)
  tenants         User[]    @relation("EstateTenants")

  @@unique([estateId, universe])  // Composite unique constraint
  @@map("estates")
}

// Arkana World Object - Interactive objects with state-based actions
model WorldObject {
  id          Int      @id @default(autoincrement())
  objectId    String   @map("object_id")        // Unique identifier from LSL
  universe    String   @default("arkana")       // Universe (arkana)
  name        String                            // Display name
  description String?                           // Description
  location    String?                           // Location metadata
  owners      String[] @default([])             // Owner SL UUIDs (array for multiple owners)
  type        String                            // Object type (door, chest, lever, etc.)
  state       String   @default("default")      // Current state (unlocked, locked, open, closed, etc.)
  stats       Json     @default("{}")           // Custom stats (HP, durability, etc.)
  groups      Json     @default("[]")           // Allowed groups/roles
  actions     Json     @default("[]")           // Available actions with conditions
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([objectId, universe])  // Composite unique constraint
  @@map("world_objects")
}

// Arkana character creation data
model ArkanaStats {
  id                     Int       @id @default(autoincrement())
  userId                 String    @unique @map("user_id")

  // Step 1: Identity & Fiction
  characterName          String    @map("character_name")
  agentName              String    @map("agent_name")  // Second Life name
  aliasCallsign          String?   @map("alias_callsign")
  faction                String?
  conceptRole            String?   @db.VarChar(512) @map("concept_role")
  job                    String?   @db.VarChar(256)
  background             String?   @db.Text

  // Step 2: Lineage Path
  race                   String
  subrace                String?
  archetype              String?

  // Step 3: Stats (1-5 range, HP = Physical × 5)
  physical               Int       @default(1)
  dexterity              Int       @default(1)
  mental                 Int       @default(1)
  perception             Int       @default(1)
  maxHP                  Int       @default(5) @map("max_hp")
  statPointsPool         Int       @default(10) @map("stat_points_pool")
  statPointsSpent        Int       @default(0) @map("stat_points_spent")

  // Step 4: Powers & Weaknesses
  inherentPowers         String[]  @default([]) @map("inherent_powers")
  weaknesses             String[]  @default([])

  // Step 5: Flaws (stored as JSON for name+cost pairs)
  flaws                  Json?     // [{name: "Glass Jaw", cost: 2}]
  flawPointsGranted      Int       @default(0) @map("flaw_points_granted")

  // Step 6: Purchases & Points
  powerPointsBudget      Int       @default(15) @map("power_points_budget")
  powerPointsBonus       Int       @default(0) @map("power_points_bonus")
  powerPointsSpent       Int       @default(0) @map("power_points_spent")

  commonPowers           String[]  @default([]) @map("common_powers")
  archetypePowers        String[]  @default([]) @map("archetype_powers")
  perks                  String[]  @default([])

  // Magic
  magicSchools           String[]  @default([]) @map("magic_schools")
  magicWeaves            String[]  @default([]) @map("magic_weaves")

  // Cybernetics (JSON for structured data)
  cybernetics            Json?     // [{type: "Arm", slots: 2, augments: ["Interface"]}]
  cyberneticAugments     String[]  @default([]) @map("cybernetic_augments")

  // Skills System
  skills                 Json?     @default("[]")  // Array of {skill_id: string, skill_name: string, level: number}
  skillsAllocatedPoints  Int       @default(5) @map("skills_allocated_points")
  skillsSpentPoints      Int       @default(0) @map("skills_spent_points")

  // Game Economy
  credits                Int       @default(0)
  chips                  Int       @default(0)
  xp                     Int       @default(0)

  // Active Effects System
  activeEffects          Json?     @default("[]") @map("active_effects")  // Array of ActiveEffect objects
  liveStats              Json?     @default("{}") @map("live_stats")      // Dynamic stat calculations

  // Metadata
  registrationCompleted  Boolean   @default(false) @map("registration_completed")
  arkanaRole             String    @default("player") @map("arkana_role")  // "player" or "admin"
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  // Relations
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("arkana_stats")
}

// Gorean character creation data - Multi-dimensional taxonomy
model GoreanStats {
  id                    Int       @id @default(autoincrement())
  userId                String    @unique @map("user_id")

  // Step 1: Identity & Background
  characterName         String    @map("character_name")
  agentName             String    @map("agent_name")  // Second Life name
  title                 String?   @db.VarChar(512)
  background            String?   @db.Text

  // Step 2: Species Selection (35+ species including animals!)
  species               String    // "human", "kurii", "larl", "tarn", "tabuk", etc.
  speciesCategory       String    @map("species_category")  // "sapient", "feline", "avian", etc.
  speciesVariant        String?   @map("species_variant")   // "black_larl", "northern_tabuk", "war_tarn", etc.

  // Step 3: Culture/Origin
  culture               String    // Primary cultural background
  cultureType           String    @map("culture_type")  // "cityState", "northern", "nomadic", "animal", etc.

  // Step 4: Status
  status                String    // "freeMan", "freeWoman", "kajira", "kajirus", "wild", "domesticated", etc.
  statusSubtype         String?   @map("status_subtype")  // Specific slave type or animal bond type

  // Step 5: Caste/Role (varies by culture - castes for cities, roles for tribes)
  casteRole             String?   @map("caste_role")  // Caste for cities, Role for tribal/animal
  casteRoleType         String?   @map("caste_role_type")  // "highCaste", "lowCaste", "tribalRole", etc.

  // Step 6: Region/City (optional)
  region                String?   // Specific city, tribe, or geographic region
  homeStoneName         String?   @map("home_stone_name")  // Name of Home Stone (if applicable)

  // Step 7: Base Stats (1-5 range, similar to Arkana but 5 stats for Gor)
  strength              Int       @default(1)  // Physical power, health, melee damage
  agility               Int       @default(1)  // Speed, reflexes, dodge, ranged accuracy
  intellect             Int       @default(1)  // Intelligence, reasoning, learning
  perception            Int       @default(1)  // Awareness, tracking, intuition
  charisma              Int       @default(1)  // Leadership, persuasion, animal handling
  statPointsPool        Int       @default(10) @map("stat_points_pool")
  statPointsSpent       Int       @default(0) @map("stat_points_spent")

  // Derived Stats (calculated from base stats)
  healthMax             Int       @default(5) @map("health_max")  // Strength × 5
  hungerMax             Int       @default(100) @map("hunger_max")
  thirstMax             Int       @default(100) @map("thirst_max")

  // Current State (runtime values synced with UserStats for Gor universe)
  healthCurrent         Int       @default(5) @map("health_current")
  hungerCurrent         Int       @default(100) @map("hunger_current")
  thirstCurrent         Int       @default(100) @map("thirst_current")

  // Game Economy (Gor uses gold/silver/copper, not credits/chips)
  goldCoin              Int       @default(0) @map("gold_coin")
  silverCoin            Int       @default(0) @map("silver_coin")
  copperCoin            Int       @default(0) @map("copper_coin")
  xp                    Int       @default(0)

  // Skills System (similar to Arkana)
  skills                Json?     @default("[]")  // Array of {skill_id, skill_name, level}
  skillsAllocatedPoints Int       @default(5) @map("skills_allocated_points")
  skillsSpentPoints     Int       @default(0) @map("skills_spent_points")

  // Active Effects System (same as Arkana for consistency)
  activeEffects         Json?     @default("[]") @map("active_effects")  // Array of ActiveEffect objects
  liveStats             Json?     @default("{}") @map("live_stats")      // Dynamic stat calculations

  // Metadata
  registrationCompleted Boolean   @default(false) @map("registration_completed")
  gorRole               String    @default("player") @map("gor_role")  // "player" or "admin"
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("gorean_stats")
}

// NPC management for task givers and other interactive agents
model NPC {
  id              Int        @id @default(autoincrement())
  npcId           String     @map("npc_id")       // Unique identifier from LSL notecard
  universe        String     @default("Gor")
  name            String
  description     String?    @db.Text
  location        String?
  maxDailyTasks   Int        @default(3) @map("max_daily_tasks")
  taskInterval    Int        @default(300) @map("task_interval") // seconds between tasks
  resetHour       Int        @default(6) @map("reset_hour")       // hour of day to reset
  minRewardMult   Int        @default(3) @map("min_reward_mult")
  maxRewardMult   Int        @default(7) @map("max_reward_mult")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  // Relations
  tasks           NPCTask[]

  @@unique([npcId, universe])
  @@map("npcs")
}

// Individual task assignments from NPCs to players
model NPCTask {
  id              Int        @id @default(autoincrement())
  npcId           Int        @map("npc_id")
  userId          String     @map("user_id")
  itemShortName   String     @map("item_short_name")
  itemName        String     @map("item_name")
  quantity        Int        @default(1)
  rewardCopper    Int        @map("reward_copper")
  status          TaskStatus @default(ASSIGNED)
  assignedAt      DateTime   @default(now()) @map("assigned_at")
  completedAt     DateTime?  @map("completed_at")
  dailyCount      Int        @default(1) @map("daily_count")

  // Relations
  npc             NPC        @relation(fields: [npcId], references: [id], onDelete: Cascade)
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([npcId, userId])
  @@map("npc_tasks")
}

enum TaskStatus {
  ASSIGNED
  COMPLETED
  DECLINED
  EXPIRED

  @@map("_task_status")
}

// Recipe management for crafting system
model Recipe {
  id                    Int       @id @default(autoincrement())
  name                  String    @db.VarChar(255)
  shortName             String    @map("short_name") @db.VarChar(100)
  universe              String    @default("Gor")
  craftingStationType   String    @map("crafting_station_type") @db.VarChar(100)
  ingredients           Json      // Array of {quantity: number, rpItemShortName: string}
  craftingTime          Int       @map("crafting_time") // Time in seconds
  outputItemShortName   String    @map("output_item_short_name") @db.VarChar(100)
  outputItemQuantity    Int       @default(1) @map("output_item_quantity")
  knowledge             String?   @db.VarChar(255) // Optional knowledge requirement
  tool                  String?   @db.VarChar(255) // Optional tool requirement
  license               String?   @db.VarChar(255) // Optional license requirement
  category              String    @db.VarChar(100)
  tags                  String    @default("") @db.VarChar(500)
  exp                   Int       @default(0) // Experience points awarded
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  craftings             Crafting[]

  @@unique([shortName, universe])
  @@index([craftingStationType, category])
  @@index([universe])
  @@map("recipes")
}

// Crafting station management
model CraftingStation {
  id                    Int       @id @default(autoincrement())
  stationId             String    @map("station_id") @db.VarChar(100) // Station identifier from LSL
  universe              String    @default("Gor")
  name                  String    @db.VarChar(255)
  type                  String    @db.VarChar(100) // Type of crafting station (cooking, forge, etc.)
  busy                  Boolean   @default(false)
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  craftings             Crafting[]

  @@unique([stationId, universe])
  @@index([universe, type])
  @@map("crafting_stations")
}

// Individual crafting sessions
model Crafting {
  id                    Int       @id @default(autoincrement())
  universe              String    @default("Gor")
  userId                String    @map("user_id")
  craftingStationId     Int       @map("crafting_station_id")
  recipeShortName       String    @map("recipe_short_name") @db.VarChar(100)
  startTime             DateTime  @default(now()) @map("start_time")
  collected             Boolean   @default(false)
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  user                  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  craftingStation       CraftingStation @relation(fields: [craftingStationId], references: [id], onDelete: Cascade)
  recipe                Recipe         @relation(fields: [recipeShortName, universe], references: [shortName, universe], onDelete: Cascade)

  @@index([userId, collected])
  @@index([craftingStationId, collected])
  @@index([universe])
  @@map("craftings")
}

enum Role {
  FREE      @map("Free")
  SLAVE     @map("Slave")
  JARL      @map("Jarl")
  BONDMAID  @map("Bondmaid")
  PANTHER   @map("Panther")
  OUTLAW    @map("Outlaw")

  @@map("_role")
}
